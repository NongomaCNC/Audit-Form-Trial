<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Field Data Capture</title>

    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        /* ---------- BASIC LAYOUT ---------- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --cyan-color: #0dcaf0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background: #f2f2f2;
            color: var(--dark-color);
            -webkit-tap-highlight-color: transparent;
        }
        .main-content {
            display: none;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
        }

        form {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
            max-width: 900px;
            margin: auto;
            margin-bottom: 2rem;
        }
        @media (min-width: 600px) {
            form {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* ---------- FORM ELEMENTS ---------- */
        .field {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 0.3rem;
            font-weight: 600;
            font-size: 0.9rem;
        }
        label .required-star {
            color: var(--danger-color);
            font-weight: bold;
            margin-left: 2px;
        }
        input, select, textarea {
            padding: 0.6rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        input[readonly] {
            background-color: #e9e9e9;
            cursor: not-allowed;
        }

        /* ---------- BUTTONS ---------- */
        .actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1rem;
        }
        button {
            flex: 1 1 auto;
            min-width: 120px;
            border: none;
            border-radius: 5px;
            color: #fff;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        #gpsBtn { background: var(--success-color); }
        #submitBtn { background: var(--primary-color); }
        #viewDataBtn { background: var(--info-color); }
        #downloadOnlyBtn { background: var(--cyan-color); color: #000; }
        #clearDataBtn { background: var(--danger-color); }
        #closeViewDataBtn { background: var(--secondary-color); }

        /* ---------- MESSAGES & MODALS ---------- */
        #message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
            text-align: center;
            white-space: pre-wrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 90%;
            width: 350px;
        }

        /* ---------- SAVED DATA SECTION ---------- */
        #savedDataSection {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,.1);
            max-width: 900px;
            margin: auto;
            margin-top: 2rem;
            display: none;
        }
        #savedDataSection.visible {
            display: block;
        }
        #savedDataTableContainer {
            overflow-x: auto;
            max-width: 100%;
        }
        #savedDataTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        #savedDataTable th, #savedDataTable td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }
    </style>
</head>
<body>

    <div id="passwordModal" class="modal-overlay visible">
        <div class="modal-content">
            <h2>Data Encryption</h2>
            <p>Enter a password to encrypt and decrypt your data.</p>
            <input type="password" id="passwordInput" placeholder="Data Password">
            <div class="modal-actions">
                <button id="passwordSubmit" style="background-color: var(--success-color);">Unlock Data</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirmTitle">Are you sure?</h2>
            <p id="confirmMessage"></p>
            <div class="modal-actions">
                <button id="confirmYesBtn" style="background-color: var(--success-color);">Yes</button>
                <button id="confirmNoBtn" style="background-color: var(--secondary-color);">No</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <h1>Audit Data Capture</h1>

        <form id="captureForm" novalidate>
            <input type="hidden" id="recordId" name="id">

            <div class="field"><label for="contractorName">Contractor Name or Other Source</label><input id="contractorName" name="contractorName" type="text"></div>
            <div class="field"><label for="zone">Zone</label><input id="zone" name="zone" type="text" placeholder="e.g., Empangeni"></div>
            <div class="field"><label for="sector">Sector</label><input id="sector" name="sector" type="text" placeholder="e.g., Pongola"></div>
            <div class="field"><label for="cnc">CNC</label><input id="cnc" name="cnc" type="text"></div>
            <div class="field"><label for="removalCode">RemovalCode</label><input id="removalCode" name="removalCode" type="text"></div>
            <div class="field"><label for="supplyType">SupplyType</label><input id="supplyType" name="supplyType" type="text"></div>
            <div class="field"><label for="unitsOnNewMeter">Units On NewMeter</label><input id="unitsOnNewMeter" name="unitsOnNewMeter" type="text"></div>
            <div class="field"><label for="unitsOnRemovedMeter">Units on RemovedMeter</label><input id="unitsOnRemovedMeter" name="unitsOnRemovedMeter" type="text"></div>
            <div class="field"><label for="creditsToIssue">Credits To Be Issued</label><input id="creditsToIssue" name="creditsToIssue" type="text"></div>
            <div class="field"><label for="worksOrderNo">WorksOrderNumber</label><input id="worksOrderNo" name="worksOrderNo" type="text"></div>
            <div class="field"><label for="onPrevious">On Previous</label><input id="onPrevious" name="onPrevious" type="text"></div>
            <div class="field"><label for="date">Date</label><input id="date" type="date" name="date"></div>
            <div class="field"><label for="time">Time</label><input id="time" type="time" name="time"></div>
            <div class="field"><label for="featureName">FeatureName</label><input id="featureName" type="text" name="featureName"></div>
            <div class="field"><label for="testerID">TesterID</label><input id="testerID" name="testerID" type="text"></div>
            <div class="field"><label for="feederName">FeederName</label><input id="feederName" name="feederName" type="text"></div>
            <div class="field"><label for="townshipId">TownshipID</label><input id="townshipId" name="townshipId" type="text"></div>
            <div class="field"><label for="townshipName">TownshipName</label><input id="townshipName" name="townshipName" type="text"></div>
            <div class="field"><label for="xformerNo">XformerNo</label><input id="xformerNo" name="xformerNo" type="text"></div>
            <div class="field"><label for="standNo">StandNo</label><input id="standNo" name="standNo" type="text"></div>
            <div class="field"><label for="installationNo">InstallNo</label><input id="installationNo" name="installationNo" type="text"></div>
            <div class="field"><label for="lat">Latitude (DD MM SS.SSS S/N)</label><input id="lat" name="Latitude" type="text" readonly></div>
            <div class="field"><label for="lon">Longitude (DD MM SS.SSS E/W)</label><input id="lon" name="Longitude" type="text" readonly></div>
            <div class="field"><label for="access">Access</label><select id="access" name="access"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="atHome">AtHome</label><select id="atHome" name="atHome"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="connected">Connected</label><select id="connected" name="connected"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="abandoned">Abandoned</label><select id="abandoned" name="abandoned"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="vandalised">Vandalised</label><select id="vandalised" name="vandalised"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="illegal">Illegal</label><select id="illegal" name="illegal"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="owner">Owner</label><select id="owner" name="owner"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="surname">Surname</label><input id="surname" name="surname" type="text"></div>
            <div class="field"><label for="name">Name</label><input id="name" name="name" type="text"></div>
            <div class="field"><label for="idNo">IDno</label><input id="idNo" name="idNo" type="text" inputmode="numeric" maxlength="13"></div>
            <div class="field"><label for="phoneCode">PhoneCode</label><input id="phoneCode" name="phoneCode" type="tel" maxlength="3"></div>
            <div class="field"><label for="phoneNo">PhoneNo</label><input id="phoneNo" name="phoneNo" type="tel" maxlength="7"></div>
            <div class="field"><label for="normalVendor">NormalVendor</label><select id="normalVendor" name="normalVendor"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="recentVendor">MostRecentVendor</label><input id="recentVendor" name="recentVendor" type="text"></div>
            <div class="field"><label for="meterNo">MeterNo</label><input id="meterNo" name="meterNo" type="text" maxlength="11"></div>
            <div class="field"><label for="split">Split</label><select id="split" name="split"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="commonBaseMeter">Common or Non Common Base Meter</label><input id="commonBaseMeter" name="commonBaseMeter" type="text"></div>
            <div class="field"><label for="edEcu">ED/ECU</label><select id="edEcu" name="edEcu"><option value="">— Select —</option><option value="ED">ED</option><option value="ECU">ECU</option></select></div>
            <div class="field"><label for="meterField">MeterType</label><input id="meterField" name="meterField" type="text"></div>
            <div class="field"><label for="otherMeterType">OtherMeterType</label><input id="otherMeterType" name="otherMeterType" type="text"></div>
            <div class="field"><label for="tariffCode">TariffCode</label><input id="tariffCode" name="tariffCode" type="text"></div>
            <div class="field"><label for="ampLimit">AmpLimit</label><input id="ampLimit" name="ampLimit" type="number"></div>
            <div class="field"><label for="supplyGroupCode">Supply Group Code</label><input id="supplyGroupCode" name="supplyGroupCode" type="text"></div>
            <div class="field"><label for="meterTariffIndex">MeterTariffIndex</label><input id="meterTariffIndex" name="meterTariffIndex" type="text"></div>
            <div class="field"><label for="magCard">MagCard/Keypad</label><select id="magCard" name="magCard"><option value="">— Select —</option><option value="Mag Card">Mag Card</option><option value="Keypad">Keypad</option></select></div>
            <div class="field"><label for="stsOrProp">STSorProp</label><input id="stsOrProp" name="stsOrProp" type="text"></div>
            <div class="field"><label for="tampered">Tampered</label><select id="tampered" name="tampered"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="tamperMethod">TamperMethod</label><input id="tamperMethod" name="tamperMethod" type="text"></div>
            <div class="field"><label for="removed">Removed</label><select id="removed" name="removed"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="tamperNotNo">TamperNotNo</label><input id="tamperNotNo" name="tamperNotNo" type="text"></div>
            <div class="field"><label for="cardTrip">CardTrip</label><select id="cardTrip" name="cardTrip"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
            <div class="field"><label for="elTest">E/LTest</label><select id="elTest" name="elTest"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
            <div class="field"><label for="sgc">SupplyGroupCode</label><input id="sgc" name="sgc" type="text"></div>
            <div class="field"><label for="meterFaulty">Faulty</label><select id="meterFaulty" name="meterFaulty"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="replaced">Replaced</label><select id="replaced" name="replaced"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="mmfNo">MeterChOutNo</label><input id="mmfNo" name="mmfNo" type="text"></div>
            <div class="field"><label for="newMeterNo">NewMeterNo</label><input id="newMeterNo" name="newMeterNo" type="text"></div>
            <div class="field"><label for="newMeterType">NewMeterType</label><input id="newMeterType" name="newMeterType" type="text"></div>
            <div class="field"><label for="newMeterAmpLimit">NewAmpLimit</label><input id="newMeterAmpLimit" name="newMeterAmpLimit" type="number"></div>
            <div class="field"><label for="newSupplyGroupCode">New Supply Group Code</label><input id="newSupplyGroupCode" name="newSupplyGroupCode" type="text"></div>
            <div class="field"><label for="newMeterCardTrip">CardTripNewMet</label><select id="newMeterCardTrip" name="newMeterCardTrip"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
            <div class="field"><label for="newMeterElTest">E/LTestNewMet</label><select id="newMeterElTest" name="newMeterElTest"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
            <div class="field"><label for="sealed">Sealed</label><select id="sealed" name="sealed"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="sealNo">Seal No</label><input id="sealNo" name="sealNo" type="text"></div>
            <div class="field"><label for="remarks">Remarks</label><textarea id="remarks" name="remarks"></textarea></div>

            <div class="actions">
                <button type="button" id="gpsBtn">Get GPS</button>
                <button type="submit" id="submitBtn">Save Data</button>
                <button type="button" id="viewDataBtn">View Data</button>
                <button type="button" id="downloadOnlyBtn">Download</button>
            </div>
        </form>

        <div id="message" role="alert" aria-live="polite"></div>

        <div id="savedDataSection">
            <h2>Saved Field Entries</h2>
            <div id="dataCounts" style="text-align:center; margin-bottom:1rem;"></div>
            <div id="savedDataTableContainer">
                <table id="savedDataTable">
                    <thead id="savedTableHeader"></thead>
                    <tbody id="savedTableBody"></tbody>
                </table>
            </div>
            <div class="actions">
                <button type="button" id="clearDataBtn">Clear All Saved Data</button>
                <button type="button" id="closeViewDataBtn">Close View</button>
            </div>
        </div>
    </div>

    <script>
        // PWA Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .catch(error => console.log('SW registration failed: ', error));
            });
        }
    
        const DB_NAME = 'FieldDataDB';
        const DB_VERSION = 2;
        const STORE_NAME = 'records';
        let db;
        let encryptionKey;

        // --- CRYPTOGRAPHY ---
        async function getKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
            );
            return window.crypto.subtle.deriveKey(
                { "name": "PBKDF2", salt: salt, "iterations": 100000, "hash": "SHA-256" },
                keyMaterial, { "name": "AES-GCM", "length": 256 }, true, ["encrypt", "decrypt"]
            );
        }

        async function encryptData(dataObject) {
            if (!encryptionKey) throw new Error("Encryption key not set.");
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const enc = new TextEncoder();
            const encodedData = enc.encode(JSON.stringify(dataObject));
            const encryptedContent = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, encryptionKey, encodedData);
            return { iv: Array.from(iv), data: Array.from(new Uint8Array(encryptedContent)) };
        }

        async function decryptData(encryptedPackage) {
            const iv = new Uint8Array(encryptedPackage.iv);
            const content = new Uint8Array(encryptedPackage.data);
            const decryptedContent = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, encryptionKey, content);
            return JSON.parse(new TextDecoder().decode(decryptedContent));
        }

        // --- DATABASE ---
        function initDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function addRecord(data) {
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            return new Promise((resolve, reject) => {
                const request = transaction.objectStore(STORE_NAME).add({ encryptedData: data });
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function getAllRecords() {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            return new Promise((resolve, reject) => {
                const request = transaction.objectStore(STORE_NAME).getAll();
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        // --- GPS & HELPERS ---
        function toDMS(dec, type) {
            const abs = Math.abs(dec);
            const deg = Math.floor(abs);
            const minF = (abs - deg) * 60;
            const min = Math.floor(minF);
            const sec = ((minF - min) * 60).toFixed(3);
            const hemisphere = dec >= 0 ? (type === 'latitude' ? 'N' : 'E') : (type === 'latitude' ? 'S' : 'W');
            return `${String(deg).padStart(2, '0')} ${String(min).padStart(2, '0')} ${sec.padStart(6, '0')} ${hemisphere}`;
        }

        function showMessage(msg, type = 'info') {
            const el = document.getElementById('message');
            el.textContent = msg;
            el.className = 'show';
            el.style.backgroundColor = type === 'error' ? 'rgba(220, 53, 69, 0.9)' : (type === 'success' ? 'rgba(40, 167, 69, 0.9)' : 'rgba(0, 0, 0, 0.8)');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // --- EXPORT ---
        async function performDownload() {
            const encryptedRecords = await getAllRecords();
            if (encryptedRecords.length === 0) return showMessage('No data to export.', 'info');

            const records = [];
            for (const rec of encryptedRecords) {
                try { records.push(await decryptData(rec.encryptedData)); } catch(e) { return showMessage('Decryption failed. Wrong password?', 'error'); }
            }

            const excelHeaderMap = {
                'featureName': 'FeatureName',
                'xformerNo': 'XformerNo',
                'newSupplyGroupCode': 'New Supply Group Code',
                'Latitude': 'Latitude',
                'Longitude': 'Longitude',
                'contractorName': 'Contractor Name or Other Source',
                'townshipId': 'TownshipID',
                'meterField': 'MeterType',
                'mmfNo': 'MeterChOutNo',
                'newMeterCardTrip': 'CardTripNewMet',
                'newMeterElTest': 'E/LTestNewMet',
                'sgc': 'SupplyGroupCode'
            };

            const formFieldOrder = Array.from(document.getElementById('captureForm').elements)
                .map(el => el.name).filter((name, idx, self) => name && self.indexOf(name) === idx && name !== 'id');

            const formatted = records.map(rec => {
                const obj = {};
                formFieldOrder.forEach(key => {
                    const header = excelHeaderMap[key] || document.querySelector(`label[for="${document.getElementsByName(key)[0]?.id}"]`)?.textContent.replace('*','') || key;
                    obj[header] = rec[key] || '';
                });
                return obj;
            });

            const ws = XLSX.utils.json_to_sheet(formatted);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'FieldData');
            XLSX.writeFile(wb, 'Field_Data.xlsx');
            showMessage('Data exported!', 'success');
        }

        // --- EVENT LISTENERS ---
        document.getElementById('passwordSubmit').onclick = async () => {
            const pw = document.getElementById('passwordInput').value;
            if (pw.length < 8) return showMessage('Password too short.', 'error');
            encryptionKey = await getKey(pw, new TextEncoder().encode("a-static-salt-for-the-pwa"));
            document.getElementById('passwordModal').classList.remove('visible');
            document.querySelector('.main-content').style.display = 'block';
            await initDb();
        };

        document.getElementById('gpsBtn').onclick = () => {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('lat').value = toDMS(pos.coords.latitude, 'latitude');
                document.getElementById('lon').value = toDMS(pos.coords.longitude, 'longitude');
                showMessage('GPS acquired!', 'success');
            }, err => showMessage('GPS Error', 'error'), { enableHighAccuracy: true });
        };

        document.getElementById('captureForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            data.date = data.date ? data.date.replace(/-/g, '/') : '';
            const encrypted = await encryptData(data);
            await addRecord(encrypted);
            showMessage('Saved!', 'success');
            e.target.reset();
        };

        document.getElementById('downloadOnlyBtn').onclick = performDownload;
        
        document.getElementById('viewDataBtn').onclick = async () => {
            const section = document.getElementById('savedDataSection');
            if (section.classList.contains('visible')) return section.classList.remove('visible');
            const records = await getAllRecords();
            const tbody = document.getElementById('savedTableBody');
            tbody.innerHTML = '';
            for (let rec of records) {
                const data = await decryptData(rec.encryptedData);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${rec.id}</td><td>${data.cnc || ''}</td><td>${data.meterNo || ''}</td>`;
                tbody.appendChild(tr);
            }
            section.classList.add('visible');
        };

        document.getElementById('closeViewDataBtn').onclick = () => document.getElementById('savedDataSection').classList.remove('visible');
    </script>
</body>
</html>
