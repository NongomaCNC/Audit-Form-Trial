<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Field Data Capture</title>

    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        /* ---------- BASIC LAYOUT ---------- */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --cyan-color: #0dcaf0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background: #f2f2f2;
            color: var(--dark-color);
            -webkit-tap-highlight-color: transparent;
        }
        .main-content {
            display: none; 
        }
        h1 {
            text-align: center;
            color: #333;
            margin-top: 0.5rem;
            margin-bottom: 1.5rem;
        }

        form {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
            max-width: 900px;
            margin: auto;
            margin-bottom: 2rem;
        }
        @media (min-width: 600px) {
            form {
                grid-template-columns: 1fr 1fr;
            }
        }

        .field {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 0.3rem;
            font-weight: 600;
            font-size: 0.9rem;
        }
        label .required-star {
            color: var(--danger-color);
            font-weight: bold;
            margin-left: 2px;
        }
        input, select, textarea {
            padding: 0.6rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        input[readonly] {
            background-color: #e9e9e9;
            cursor: not-allowed;
        }

        .actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1rem;
        }
        button {
            flex: 1 1 auto;
            min-width: 120px;
            border: none;
            border-radius: 5px;
            color: #fff;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        #gpsBtn { background: var(--success-color); }
        #submitBtn { background: var(--primary-color); }
        #viewDataBtn { background: var(--info-color); }
        #downloadOnlyBtn { background: var(--cyan-color); color: #000; }
        #clearDataBtn { background: var(--danger-color); }
        #closeViewDataBtn { background: var(--secondary-color); }

        #message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
            text-align: center;
            white-space: pre-wrap;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        #message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 90%;
            width: 350px;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        #savedDataSection {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,.1);
            max-width: 900px;
            margin: auto;
            margin-top: 2rem;
            display: none;
        }
        #savedDataSection.visible {
            display: block;
        }
        #savedDataTableContainer {
            overflow-x: auto;
            max-width: 100%;
        }
        #savedDataTable {
            width: 100%;
            border-collapse: collapse;
        }
        #savedDataTable th, #savedDataTable td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }
        #savedDataTable th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div id="passwordModal" class="modal-overlay visible">
        <div class="modal-content">
            <h2>Data Encryption</h2>
            <p>Enter a password to encrypt/decrypt your data.</p>
            <input type="password" id="passwordInput" placeholder="Data Password">
            <div class="modal-actions">
                <button id="passwordSubmit">Unlock Data</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirmTitle">Are you sure?</h2>
            <p id="confirmMessage"></p>
            <div class="modal-actions">
                <button id="confirmYesBtn">Yes</button>
                <button id="confirmNoBtn">No</button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <h1>Audit Data Capture</h1>

        <form id="captureForm" novalidate>
            <input type="hidden" id="recordId" name="id">

            <div class="field"><label for="contractorName">Contractor Name</label><input id="contractorName" name="contractorName" type="text"></div>
            <div class="field"><label for="zone">Zone</label><input id="zone" name="zone" type="text"></div>
            <div class="field"><label for="sector">Sector</label><input id="sector" name="sector" type="text"></div>
            <div class="field"><label for="cnc">CNC</label><input id="cnc" name="cnc" type="text"></div>
            
            <div class="field"><label for="removalCode">Removal Code</label><input id="removalCode" name="removalCode" type="text"></div>
            <div class="field"><label for="supplyType">Supply type</label><input id="supplyType" name="supplyType" type="text"></div>
            <div class="field"><label for="unitsOnNewMeter">Units On New Meter</label><input id="unitsOnNewMeter" name="unitsOnNewMeter" type="text"></div>
            <div class="field"><label for="unitsOnRemovedMeter">Units on Removed Meter</label><input id="unitsOnRemovedMeter" name="unitsOnRemovedMeter" type="text"></div>
            <div class="field"><label for="creditsToIssue">Credits to be issued</label><input id="creditsToIssue" name="creditsToIssue" type="text"></div>
            <div class="field"><label for="worksOrderNo">Works Order No</label><input id="worksOrderNo" name="worksOrderNo" type="text"></div>

            <div class="field"><label for="onPrevious">On Previous</label><input id="onPrevious" name="onPrevious" type="text"></div>
            <div class="field"><label for="date">Date</label><input id="date" type="date" name="date"></div>
            <div class="field"><label for="time">Time</label><input id="time" type="time" name="time"></div>
            <div class="field"><label for="featureName">FeatureName(Auditing/MeterChangeout)</label><input id="featureName" type="text" name="featureName"></div>
            <div class="field"><label for="testerID">TesterID</label><input id="testerID" name="testerID" type="text"></div>
            <div class="field"><label for="feederName">Feeder Name</label><input id="feederName" name="feederName" type="text"></div>
            <div class="field"><label for="townshipId">Township ID</label><input id="townshipId" name="townshipId" type="text"></div>
            <div class="field"><label for="townshipName">Township Name</label><input id="townshipName" name="townshipName" type="text"></div>
            <div class="field"><label for="xformerNo">XformerNo</label><input id="xformerNo" name="xformerNo" type="text"></div>
            <div class="field"><label for="standNo">Stand No</label><input id="standNo" name="standNo" type="text"></div>
            <div class="field"><label for="installationNo">Installation No</label><input id="installationNo" name="installationNo" type="text"></div>
            <div class="field"><label for="lat">Latitude</label><input id="lat" name="latitude" type="text" readonly></div>
            <div class="field"><label for="lon">Longitude</label><input id="lon" name="longitude" type="text" readonly></div>
            
            <div class="field"><label for="access">Access</label><select id="access" name="access"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="atHome">At Home</label><select id="atHome" name="atHome"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="connected">Connected</label><select id="connected" name="connected"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="abandoned">Abandoned</label><select id="abandoned" name="abandoned"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="vandalised">Vandalised</label><select id="vandalised" name="vandalised"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="illegal">Illegal</label><select id="illegal" name="illegal"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="owner">Owner</label><select id="owner" name="owner"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="surname">Surname</label><input id="surname" name="surname" type="text"></div>
            <div class="field"><label for="name">Name</label><input id="name" name="name" type="text"></div>
            <div class="field"><label for="idNo">ID No</label><input id="idNo" name="idNo" type="text" maxlength="13"></div>
            <div class="field"><label for="phoneCode">Phone Code</label><input id="phoneCode" name="phoneCode" type="tel" maxlength="3"></div>
            <div class="field"><label for="phoneNo">Phone No</label><input id="phoneNo" name="phoneNo" type="tel" maxlength="7"></div>
            <div class="field"><label for="normalVendor">Normal Vendor</label><select id="normalVendor" name="normalVendor"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="recentVendor">Most Recent Vendor</label><input id="recentVendor" name="recentVendor" type="text"></div>
            <div class="field"><label for="meterNo">Meter No</label><input id="meterNo" name="meterNo" type="text" maxlength="11"></div>
            <div class="field"><label for="split">Split</label><select id="split" name="split"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="commonBaseMeter">Common/Non Common Base Meter</label><input id="commonBaseMeter" name="commonBaseMeter" type="text"></div>
            <div class="field"><label for="edEcu">ED/ECU</label><select id="edEcu" name="edEcu"><option value="">— Select —</option><option value="ED">ED</option><option value="ECU">ECU</option></select></div>
            <div class="field"><label for="meterField">Meter Field</label><input id="meterField" name="meterField" type="text"></div>
            <div class="field"><label for="otherMeterType">Other Meter Type</label><input id="otherMeterType" name="otherMeterType" type="text"></div>
            <div class="field"><label for="tariffCode">Tariff Code</label><input id="tariffCode" name="tariffCode" type="text"></div>
            <div class="field"><label for="ampLimit">Amp Limit</label><input id="ampLimit" name="ampLimit" type="number"></div>
            <div class="field"><label for="supplyGroupCode">Supply Group Code</label><input id="supplyGroupCode" name="supplyGroupCode" type="text"></div>
            <div class="field"><label for="illegalConnection">Illegal Connection</label><select id="illegalConnection" name="illegalConnection"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="meterTariffIndex">MeterTariffIndex</label><input id="meterTariffIndex" name="meterTariffIndex" type="text"></div>
            <div class="field"><label for="magCard">Mag Card/Keypad</label><select id="magCard" name="magCard"><option value="">— Select —</option><option value="Mag Card">Mag Card</option><option value="Keypad">Keypad</option></select></div>
            <div class="field"><label for="stsOrProp">STS or Prop</label><input id="stsOrProp" name="stsOrProp" type="text"></div>
            <div class="field"><label for="tampered">Tampered</label><select id="tampered" name="tampered"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="tamperMethod">Tamper Method</label><input id="tamperMethod" name="tamperMethod" type="text"></div>
            <div class="field"><label for="removed">Removed</label><select id="removed" name="removed"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="tamperNotNo">Tamper Not No</label><input id="tamperNotNo" name="tamperNotNo" type="text"></div>
            <div class="field"><label for="tamperWaiver">TamperWaiver</label><input id="tamperWaiver" name="tamperWaiver" type="text"></div>
            <div class="field"><label for="cardTrip">Card Trip</label><select id="cardTrip" name="cardTrip"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
            <div class="field"><label for="elTest">E/L Test</label><select id="elTest" name="elTest"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
            
            <div class="field"><label for="supplyGroupCode2">Supply Group Code</label><input id="supplyGroupCode2" name="supplyGroupCode2" type="text"></div>

            <div class="field"><label for="newSupplyGroupCode">NewSupplyGroupCode</label><input id="newSupplyGroupCode" name="newSupplyGroupCode" type="text"></div>
            <div class="field"><label for="meterFaulty">Meter Faulty</label><select id="meterFaulty" name="meterFaulty"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="replaced">Replaced</label><select id="replaced" name="replaced"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="mmfNo">MMF No</label><input id="mmfNo" name="mmfNo" type="text"></div>
            <div class="field"><label for="newMeterNo">New Meter No</label><input id="newMeterNo" name="newMeterNo" type="text"></div>
            <div class="field"><label for="newMeterType">New Meter Type</label><input id="newMeterType" name="newMeterType" type="text"></div>
            <div class="field"><label for="newMeterAmpLimit">New Meter Amp Limit</label><input id="newMeterAmpLimit" name="newMeterAmpLimit" type="number"></div>
            <div class="field"><label for="newMeterCardTrip">New Meter Card Trip</label><select id="newMeterCardTrip" name="newMeterCardTrip"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
            <div class="field"><label for="newMeterElTest">New Meter E/L Test</label><select id="newMeterElTest" name="newMeterElTest"><option value="">— Select —</option><option value="Pass">Pass</option><option value="Fail">Fail</option></select></div>
            <div class="field"><label for="sealed">Sealed</label><select id="sealed" name="sealed"><option value="">— Select —</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
            <div class="field"><label for="sealNo">Seal No</label><input id="sealNo" name="sealNo" type="text"></div>
            <div class="field"><label for="remarks">Remarks</label><textarea id="remarks" name="remarks"></textarea></div>

            <div class="actions">
                <button type="button" id="gpsBtn">Get GPS</button>
                <button type="submit" id="submitBtn">Save Data</button>
                <button type="button" id="viewDataBtn">View Data</button>
                <button type="button" id="downloadOnlyBtn">Download</button>
            </div>
        </form>

        <div id="message" role="alert"></div>

        <div id="savedDataSection">
            <h2>Saved Entries</h2>
            <div id="dataCounts"></div>
            <div id="savedDataTableContainer">
                <table id="savedDataTable">
                    <thead id="savedTableHeader"></thead>
                    <tbody id="savedTableBody"></tbody>
                </table>
            </div>
            <div class="actions">
                <button type="button" id="clearDataBtn">Clear All</button>
                <button type="button" id="closeViewDataBtn">Close</button>
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'FieldDataDB';
        const DB_VERSION = 2;
        const STORE_NAME = 'records';
        let db, encryptionKey;

        // --- CRYPTO (PBKDF2 + AES-GCM) ---
        async function getKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
            return window.crypto.subtle.deriveKey({ "name": "PBKDF2", salt, "iterations": 100000, "hash": "SHA-256" }, keyMaterial, { "name": "AES-GCM", "length": 256 }, true, ["encrypt", "decrypt"]);
        }

        async function encryptData(dataObject) {
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encodedData = new TextEncoder().encode(JSON.stringify(dataObject));
            const encryptedContent = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, encryptionKey, encodedData);
            return { iv: Array.from(iv), data: Array.from(new Uint8Array(encryptedContent)) };
        }

        async function decryptData(encryptedPackage) {
            const decryptedContent = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(encryptedPackage.iv) }, encryptionKey, new Uint8Array(encryptedPackage.data));
            return JSON.parse(new TextDecoder().decode(decryptedContent));
        }

        // --- DB & FORM HANDLING ---
        function initDb() {
            return new Promise((resolve) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(); };
            });
        }

        // Automatically detects all named fields for table/Excel
        const formFieldOrder = Array.from(document.getElementById('captureForm').elements)
            .map(el => el.name).filter((name, i, self) => name && self.indexOf(name) === i && name !== 'id');

        document.getElementById('passwordSubmit').onclick = async () => {
            const pass = document.getElementById('passwordInput').value;
            if (pass.length < 8) return alert("Min 8 chars");
            encryptionKey = await getKey(pass, new TextEncoder().encode("a-static-salt-for-the-pwa"));
            document.getElementById('passwordModal').classList.remove('visible');
            document.querySelector('.main-content').style.display = 'block';
            await initDb();
        };

        document.getElementById('captureForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const recordId = data.id ? parseInt(data.id) : null;
            delete data.id;

            const encrypted = await encryptData(data);
            const tx = db.transaction(STORE_NAME, 'readwrite');
            recordId ? tx.objectStore(STORE_NAME).put({ id: recordId, encryptedData: encrypted }) : tx.objectStore(STORE_NAME).add({ encryptedData: encrypted });
            
            alert("Data Saved Successfully!");
            e.target.reset();
        };

        document.getElementById('downloadOnlyBtn').onclick = async () => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const all = await new Promise(r => tx.objectStore(STORE_NAME).getAll().onsuccess = e => r(e.target.result));
            const decrypted = await Promise.all(all.map(rec => decryptData(rec.encryptedData)));
            
            const ws = XLSX.utils.json_to_sheet(decrypted);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "FieldData");
            XLSX.writeFile(wb, "Field_Data_Capture.xlsx");
        };

        // GPS Logic preserved
        document.getElementById('gpsBtn').onclick = () => {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
                document.getElementById('lon').value = pos.coords.longitude.toFixed(6);
            });
        };

        // Logic for Automatic status changes preserved
        document.getElementById('edEcu').onchange = (e) => {
            const amp = document.getElementById('ampLimit');
            if (e.target.value === 'ED') { amp.value = 60; amp.readOnly = true; }
            else if (e.target.value === 'ECU') { amp.value = 20; amp.readOnly = true; }
            else { amp.value = ''; amp.readOnly = false; }
        };
    </script>
</body>
</html>
